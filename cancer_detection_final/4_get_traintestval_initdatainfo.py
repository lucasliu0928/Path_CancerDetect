#!/usr/bin/env python# coding: utf-8#NOTE: use paimg9 envimport sysimport osimport matplotlibmatplotlib.use('Agg')import pandas as pdimport warningsimport torchimport argparsefrom sklearn.model_selection import KFold, train_test_splitsys.path.insert(0, '../Utils/')from Utils import create_dir_if_not_existsfrom Utils import count_labelfrom Utils import set_seedfrom train_utils import get_feature_label_array_dynamicwarnings.filterwarnings("ignore")def get_initdatainfo(TUMOR_FRAC_THRES, TRAIN_SAMPLE_SIZE, TRAIN_OVERLAP, TEST_OVERLAP, SELECTED_FOLD , EXTRACTION_METHOD):    ############################################################################################################    #Select Label and Features    ############################################################################################################    SELECTED_LABEL = ["AR","MMR (MSH2, MSH6, PMS2, MLH1, MSH3, MLH3, EPCAM)2","PTEN","RB1","TP53","TMB_HIGHorINTERMEDITATE","MSI_POS"]    SELECTED_FEATURE = [str(i) for i in range(0,2048)] + ['TUMOR_PIXEL_PERC']    ############################################################################################################    ###### DIR      ############################################################################################################    proj_dir = '/fh/fast/etzioni_r/Lucas/mh_proj/mutation_pred/'    id_path = proj_dir + '/data/OPX/'    ft_ids_path =  proj_dir + 'intermediate_data/cd_finetune/cancer_detection_training/' #the ID used for fine-tuning cancer detection model, needs to be excluded from mutation study    train_tile_path = proj_dir + 'intermediate_data/cancer_prediction_results110224/IMSIZE250_OL' + str(TRAIN_OVERLAP) + '/'    test_tile_path =  proj_dir + 'intermediate_data/cancer_prediction_results110224/IMSIZE250_OL' + str(TEST_OVERLAP) + '/'    ############################################################################################################    #Create output dir    ############################################################################################################    outdir =   proj_dir + 'intermediate_data/model_ready_data/feature_' + EXTRACTION_METHOD + '/MAXSS'+ str(TRAIN_SAMPLE_SIZE)  + '_TrainOL' + str(TRAIN_OVERLAP) +  '_TestOL' + str(TEST_OVERLAP) + '_TFT' + str(TUMOR_FRAC_THRES) + '/'    create_dir_if_not_exists(outdir)    outdir2 =  outdir + "/split_fold" + str(SELECTED_FOLD) + "/" + "init_data_info/"     create_dir_if_not_exists(outdir2)    ############################################################################################################    #Select GPU    ############################################################################################################    device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")    print(device)    set_seed(0)    ############################################################################################################    #Select IDS    ############################################################################################################    #All available IDs    opx_ids = [x.replace('.tif','') for x in os.listdir(id_path)] #207    opx_ids.sort()    #Get IDs that are in FT train or already processed to exclude     ft_ids_df = pd.read_csv(ft_ids_path + 'all_tumor_fraction_info.csv')    ft_train_ids = list(ft_ids_df.loc[ft_ids_df['Train_OR_Test'] == 'Train','sample_id'])    #OPX_182 â€“Exclude Possible Colon AdenoCa     toexclude_ids = ft_train_ids + ['OPX_182']  #25    #Exclude ids in ft_train or processed    selected_ids = [x for x in opx_ids if x not in toexclude_ids] #199    print(len(selected_ids))    ############################################################################################################    #Get Train and test IDs, 80% - 20%    ############################################################################################################    # Number of folds    n_splits = 5    # Initialize KFold    kf = KFold(n_splits=n_splits, shuffle=True, random_state=42)    # Generate the folds    train_ids_folds = []    test_ids_folds = []    for fold, (train_index, test_index) in enumerate(kf.split(selected_ids)):        train_ids_folds.append([selected_ids[i] for i in train_index])        test_ids_folds.append([selected_ids[i] for i in test_index])    full_train_ids = train_ids_folds[SELECTED_FOLD]    test_ids = test_ids_folds[SELECTED_FOLD]    # Randomly select 5% of the train_ids for validation    train_ids, val_ids = train_test_split(full_train_ids, test_size=0.05, random_state=42)    print(len(train_ids))    print(len(val_ids))    print(len(test_ids))    ############################################################################################################    #Get features and labels    #NOTE: OPX_005 has no tumor tiles in fold0 train, so excluded in this step    ############################################################################################################    feature_name = 'features_alltiles_' +  EXTRACTION_METHOD     train_feature, train_label, train_info, train_tf_info, selected_train_ids = get_feature_label_array_dynamic(train_tile_path,feature_name, train_ids, SELECTED_LABEL,SELECTED_FEATURE,"Train" ,tumor_fraction_thres = TUMOR_FRAC_THRES,train_sample_size = TRAIN_SAMPLE_SIZE)    val_feature, val_label, val_info, val_tf_info, select_val_ids = get_feature_label_array_dynamic(train_tile_path,feature_name, val_ids, SELECTED_LABEL,SELECTED_FEATURE, "Train" ,tumor_fraction_thres = TUMOR_FRAC_THRES,train_sample_size = TRAIN_SAMPLE_SIZE)    test_feature, test_label, test_info, test_tf_info, select_test_ids = get_feature_label_array_dynamic(test_tile_path, feature_name, test_ids, SELECTED_LABEL, SELECTED_FEATURE, "Test", tumor_fraction_thres = TUMOR_FRAC_THRES)    torch.save(train_feature, outdir2 + 'train_feature.pth')    torch.save(test_feature,  outdir2 + 'test_feature.pth')    torch.save(val_feature,   outdir2 + 'val_feature.pth')    torch.save(train_label, outdir2 + 'train_label.pth')    torch.save(test_label,  outdir2 + 'test_label.pth')    torch.save(val_label,   outdir2 + 'val_label.pth')    torch.save(train_info,   outdir2 + 'train_info.pth')    torch.save(test_info,   outdir2 + 'test_info.pth')    torch.save(val_info,   outdir2 + 'val_info.pth')    torch.save(train_tf_info,   outdir2 + 'train_tf_info.pth')    torch.save(test_tf_info,   outdir2 + 'test_tf_info.pth')    torch.save(val_tf_info,   outdir2 + 'val_tf_info.pth')    torch.save(selected_train_ids,   outdir2 + 'train_ids.pth')    torch.save(select_test_ids,   outdir2 + 'test_ids.pth')    torch.save(select_val_ids,   outdir2 + 'val_ids.pth')    ############################################################################################################    #Count Distribution    ############################################################################################################    train_counts = count_label(train_label, SELECTED_LABEL, "Train")    test_counts = count_label(test_label, SELECTED_LABEL, "Test")    val_counts = count_label(val_label, SELECTED_LABEL, "Val")    all_counts = pd.concat([train_counts,test_counts,val_counts], axis = 1)    all_counts.to_csv(outdir2 + "counts.csv")def int_or_str(value):    try:        return int(value)    except ValueError:        return valuedef main():    parser = argparse.ArgumentParser()    parser.add_argument('-tft', '--tumor_fraction_threshold', type=int, help='Tumor fraction threshold for selection of tumor tiles')    parser.add_argument('-ts', '--train_sample_size', type=int_or_str, help='Sampling size for training tiles')    parser.add_argument('-train_ol', '--train_overlap', type=int, help='Training tile overlapped pixels')    parser.add_argument('-test_ol', '--test_overlap', type=int, help='Testing tile overlapped pixels')    parser.add_argument('-fi', '--fold_index', type=int, help='K-Fold index')    parser.add_argument('-em', '--extract_method', type=str, help='feature extraction method: e.g., retccl')    args = parser.parse_args(args['tumor_fraction_threshold'],         args['train_sample_size'],         args['train_overlap'],         args['test_overlap'],         args['fold_index'],         args['extract_method'])if __name__ == '__main__':    main()